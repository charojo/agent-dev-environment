#!/usr/bin/env python3
import os
import shutil
import re
from pathlib import Path

# Paths are relative to the script location for portability
SCRIPT_DIR = Path(__file__).parent.absolute()
REPO_ROOT = SCRIPT_DIR.parent.parent
SOURCE_DIR = REPO_ROOT / ".agent" / "workflows"
DEST_DIR = REPO_ROOT / "agent_env" / "workflows"

def has_description(file_path):
    """Checks if the markdown file has a description in its YAML frontmatter."""
    try:
        with open(file_path, "r") as f:
            content = f.read()
        
        # Look for description: ... within the first --- block
        frontmatter_match = re.search(r'^---\s*\n(.*?)\n---', content, re.DOTALL | re.MULTILINE)
        if not frontmatter_match:
            return False
            
        frontmatter = frontmatter_match.group(1)
        # Check for description that isn't just whitespace
        return bool(re.search(r'^description:\s*\S+', frontmatter, re.MULTILINE))
    except Exception as e:
        print(f"Error reading {file_path}: {e}")
        return False

def sync_workflows():
    if not SOURCE_DIR.exists():
        print(f"ERROR: Source directory not found: {SOURCE_DIR}")
        return

    if not DEST_DIR.exists():
        print(f"Creating destination directory: {DEST_DIR}")
        DEST_DIR.mkdir(parents=True)

    synced_count = 0
    skipped_count = 0

    print(f"Scanning {SOURCE_DIR} for workflows...")

    for src_file in SOURCE_DIR.glob("*.md"):
        dest_file = DEST_DIR / src_file.name
        
        # Enforce description check for ALL files being synced
        if not has_description(src_file):
            print(f"SKIP: {src_file.name} is missing 'description' in frontmatter.")
            skipped_count += 1
            continue

        should_sync = False
        reason = ""
        
        if not dest_file.exists():
            should_sync = True
            reason = "New file"
        else:
            src_mtime = src_file.stat().st_mtime
            dest_mtime = dest_file.stat().st_mtime
            # Allow 1 second difference for filesystem variations
            if src_mtime > dest_mtime + 1:
                should_sync = True
                reason = "Updated (newer)"
        
        if should_sync:
            shutil.copy2(src_file, dest_file)
            print(f"SYNC: {src_file.name} ({reason})")
            synced_count += 1

    print(f"\nSync complete. {synced_count} files synced, {skipped_count} skips due to missing descriptions.")

if __name__ == "__main__":
    sync_workflows()
